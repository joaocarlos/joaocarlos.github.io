{{- define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
{{- partial "index_profile.html" . }}
{{- else }} {{/* if not profileMode */}}

{{- if not .IsHome | and .Title }}
<header class="page-header">
  {{- partial "breadcrumbs.html" . }}
  <h1>
    {{- if (eq .Kind `term`) }}
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" stroke-width="2" fill="currentColor" class="bi bi-tag" viewBox="0 0 16 14"> 
      <path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0z"/> 
      <path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1zm0 5.586 7 7L13.586 9l-7-7H2v4.586z"/> 
    </svg>&nbsp; {{ .Title }}
    {{- else }}
    {{- .Title }}
    {{- end}}
  </h1>
</header>
{{- end }}

{{- if .Content }}
<div class="post-content">
  {{- if not (.Param "disableAnchoredHeadings") }}
  {{- partial "anchored_headings.html" .Content -}}
  {{- else }}{{ .Content }}{{ end }}
</div>
{{- end }}

{{- $pages := .RegularPages }}
{{- $paginator := .Paginate $pages }}

{{- if and .IsHome site.Params.homeInfoParams (eq $paginator.PageNumber 1) }}
{{- partial "home_info.html" . }}
{{- end }}

{{- $term := .Data.Term }}
{{- range $index, $page := $paginator.Pages }}

{{- $class := "book-entry" }}

{{- $user_preferred := or site.Params.disableSpecial1stPost site.Params.homeInfoParams }}
{{- if (and $.IsHome (eq $paginator.PageNumber 1) (eq $index 0) (not $user_preferred)) }}
{{- $class = "first-book-entry" }}
{{- else if $term }}
{{- $class = "book-entry tag-entry" }}
{{- end }}

<article class="{{ $class }}">
  <div class="book-entry-container">
    {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param "cover.hidden") | default false }}
    
    {{- if not $isHidden }}
    <div class="book-cover-container">
      {{- if .Params.cover.image }}
      {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
      {{- $pageBundleCover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
      {{- $globalResourcesCover := (resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
      {{- $cover := (or $pageBundleCover $globalResourcesCover)}}
      
      <figure class="book-cover">
        <a href="{{ .Permalink }}" aria-label="Go to {{ .Title | plainify }}">
          {{- if $cover }}
          <img src="{{ $cover.Permalink }}" 
               alt="{{ $alt | default .Title }}" 
               loading="lazy"
               width="{{ $cover.Width }}" 
               height="{{ $cover.Height }}">
          {{- else }}
          <img src="{{ .Params.cover.image | absURL }}" 
               alt="{{ $alt | default .Title }}" 
               loading="lazy">
          {{- end }}
        </a>
      </figure>
      {{- end }}
    </div>
    {{- end }}
    
    <div class="book-content-container">
      <header class="book-entry-header">
        <h2 class="book-entry-title">
          <a href="{{ .Permalink }}">{{ .Title }}</a>
          {{- if .Draft }}
          <span class="entry-hint" title="Draft">
            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" fill="currentColor">
              <path d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
            </svg>
          </span>
          {{- end }}
        </h2>
        
        {{- if .Params.author }}
        <div class="book-authors">
          <strong>Author(s):</strong>
          {{- if reflect.IsSlice .Params.author }}
            {{- delimit .Params.author ", " }}
          {{- else }}
            {{- .Params.author }}
          {{- end }}
        </div>
        {{- end }}
        
        {{- if not (.Param "hideMeta") }}
        <div class="book-meta">
          {{- if .Date }}
          <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
            Published: {{ .Date.Format "January 2, 2006" }}
          </time>
          {{- end }}
          {{- if .Params.tags }}
          <div class="book-tags">
            {{- range .Params.tags }}
            <span class="book-tag">{{ . }}</span>
            {{- end }}
          </div>
          {{- end }}
        </div>
        {{- end }}
      </header>
      
      {{- if (ne (.Param "hideSummary") true) }}
      <div class="book-entry-content">
        {{- if .Params.description }}
        <p><strong>Description:</strong> {{ .Params.description | plainify | htmlUnescape }}</p>
        {{- end }}
        {{- if .Summary }}
        <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
        {{- end }}
      </div>
      {{- end }}
      
      <footer class="book-entry-footer">
        {{- if .Params.editPost.URL }}
        <div class="book-publisher">
          <a href="{{ .Params.editPost.URL }}" target="_blank" rel="noopener noreferrer">
            <strong>{{ .Params.editPost.Text | default "Publisher" }}</strong>
          </a>
        </div>
        {{- end }}
        <a class="book-read-more" href="{{ .Permalink }}" aria-label="Read more about {{ .Title | plainify }}">
          Read More →
        </a>
      </footer>
    </div>
  </div>
</article>
{{- end }}

{{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer">
  <nav class="pagination">
    {{- if $paginator.HasPrev }}
    <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
      «&nbsp;{{ i18n "prev_page" }}&nbsp;
      {{- if (.Param "ShowPageNums") }}
      {{- sub $paginator.PageNumber 1 }}/{{ $paginator.TotalPages }}
      {{- end }}
    </a>
    {{- end }}
    {{- if $paginator.HasNext }}
    <a class="next" href="{{ $paginator.Next.URL | absURL }}">
      {{- i18n "next_page" }}&nbsp;
      {{- if (.Param "ShowPageNums") }}
      {{- add 1 $paginator.PageNumber }}/{{ $paginator.TotalPages }}
      {{- end }}&nbsp;»
    </a>
    {{- end }}
  </nav>
</footer>
{{- end }}

{{- end }}{{/* end profileMode */}}

{{- end }}{{/* end main */}}
